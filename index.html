<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Magic The Gathering Cards</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <!-- Navbar Organism -->
    <nav class="navbar" role="navigation" aria-label="Main navigation">
      <!-- Logo Atom -->
      <a href="#" class="logo nav-link" aria-label="Home">MTG Cards</a>

      <!-- Navigation Links Molecule -->
      <div class="nav-links">
        <a href="index.html" class="nav-link" aria-current="page">Home</a>
        <a href="Cards.html" class="nav-link">Cards</a>
        <a href="Collections.html" class="nav-link">Collections</a>
        <a href="About.html" class="nav-link">About</a>
      </div>

      <!-- Theme Toggle Atom -->
      <button
        class="theme-toggle"
        id="navThemeToggle"
        aria-label="Toggle theme between light and dark mode"
      >
        <span aria-hidden="true">ðŸŒ“</span>
        <span class="visually-hidden">Toggle theme</span>
      </button>

      <!-- Mobile Menu Toggle Atom -->
      <button
        class="menu-toggle"
        id="menuToggle"
        aria-label="Toggle navigation menu"
        aria-expanded="false"
        aria-controls="mobileMenu"
      >
        <span class="menu-toggle-line"></span>
        <span class="menu-toggle-line"></span>
        <span class="menu-toggle-line"></span>
      </button>
    </nav>

    <!-- Mobile Menu Organism -->
    <div class="mobile-menu" id="mobileMenu" aria-labelledby="menuToggle">
      <a href="index.html" class="nav-link" aria-current="page">Home</a>
      <a href="Cards.html" class="nav-link">Cards</a>
      <a href="Collections.html" class="nav-link">Collections</a>
      <a href="About.html" class="nav-link">About</a>
    </div>

    <header>
      <h1>Magic The Gathering Cards</h1>
    </header>

    <main>
      <section class="controls" role="region" aria-label="Controls">
        <div id="counter">Selected: 0</div>
        <div class="button-container">
          <button class="select" id="selectAll">Select All</button>
          <button class="deselect" id="deselectAll">Deselect All</button>
        </div>
      </section>

      <section
        class="grid"
        id="cardGrid"
        role="list"
        aria-label="Card List"
      ></section>

      <details>
        <summary>About this collection</summary>
        <p>
          This is a sample Magic The Gathering card viewer. You can select and
          deselect cards, change themes, and enjoy a smooth user experience.
          Data is fetched from the official Magic The Gathering API.
        </p>
        <p>
          <strong>Features:</strong>
        </p>
        <ul>
          <li>View card images and details</li>
          <li>Toggle between light and dark themes</li>
          <li>Select favorite cards</li>
          <li>Responsive design for all devices</li>
        </ul>
      </details>
    </main>

    <div
      class="fab"
      id="themeToggle"
      aria-label="Toggle dark/light theme"
      title="Toggle Theme"
    >
      <span aria-hidden="true">ðŸŒ“</span>
      <span class="visually-hidden">Toggle theme</span>
    </div>

    <script>
      // Utility functions
      const createElement = (tag, attributes = {}, textContent = '') => {
        const element = document.createElement(tag);
        Object.entries(attributes).forEach(([key, value]) => {
          element[key] = value;
        });
        if (textContent) {
          element.textContent = textContent;
        }
        return element;
      };

      // Card Class
      class Card {
        constructor(data, counter) {
          this.id = data.id;
          this.name = data.name;
          this.type = data.type;
          this.text = data.text;
          this.multiverseid = data.multiverseid;
          this.imageUrl = data.imageUrl || this.getFallbackImage(data);
          this.colors = data.colors;
          this.rarity = data.rarity;
          this.manaCost = data.manaCost;
          this.isSelected = false;
          this.counter = counter;
          this.element = null;
        }

        getFallbackImage(card) {
          if (card.multiverseid) {
            return `https://gatherer.wizards.com/Handlers/Image.ashx?multiverseid=${card.multiverseid}&type=card`;
          }

          if (card.name) {
            const formattedName = encodeURIComponent(card.name);
            return `https://api.scryfall.com/cards/named?exact=${formattedName}&format=image`;
          }

          return 'https://via.placeholder.com/223x310?text=No+Image+Available';
        }

        toggleSelection() {
          this.isSelected = !this.isSelected;
          if (this.isSelected) {
            this.counter.increment();
          } else {
            this.counter.decrement();
          }
          this.updateUI();
        }

        updateUI() {
          if (!this.element) return;

          this.element.classList.toggle('selected', this.isSelected);
          const btn = this.element.querySelector('button');
          btn.textContent = this.isSelected ? 'Deselect' : 'Select';
          btn.className = this.isSelected ? 'deselect' : 'select';
        }

        createManaSymbols() {
          if (!this.manaCost) return '';

          return this.manaCost.replace(/{([^}]+)}/g, (match, symbol) => {
            const symbolMap = {
              W: 'white',
              U: 'blue',
              B: 'black',
              R: 'red',
              G: 'green',
              1: '1',
              2: '2',
              3: '3',
              4: '4',
              5: '5',
              X: 'x',
              T: 'tap',
            };

            const symbolName = symbolMap[symbol] || symbol.toLowerCase();
            return `<img src="https://gatherer.wizards.com/Handlers/Image.ashx?size=small&name=${symbolName}&type=symbol" 
                     alt="${symbol}" class="mana-symbol" aria-label="${symbol} mana">`;
          });
        }

        getColorClass() {
          if (!this.colors || this.colors.length === 0) return 'color-W';
          return `color-${this.colors[0]}`;
        }

        getRarityClass() {
          switch (this.rarity) {
            case 'Uncommon':
              return 'rarity-uncommon';
            case 'Rare':
              return 'rarity-rare';
            case 'Mythic Rare':
              return 'rarity-mythic';
            default:
              return 'rarity-common';
          }
        }

        render() {
          const cardDiv = createElement('article', {
            className: 'card',
            role: 'listitem',
          });

          const title = createElement('h3', {}, this.name || 'No Name');

          const imageContainer = createElement('div');

          if (this.imageUrl) {
            const imgWrapper = createElement('div', {
              className: 'card-image-wrapper',
            });

            const loadingText = createElement(
              'div',
              {
                style:
                  'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666;',
              },
              'Loading...',
            );

            imgWrapper.appendChild(loadingText);

            const img = createElement('img', {
              src: this.imageUrl,
              alt: this.name ? `${this.name} card` : 'Magic card',
              className: 'card-image',
              loading: 'lazy',
              onload: () => {
                imgWrapper.style.background = 'none';
                loadingText.style.display = 'none';
              },
              onerror: (e) => {
                e.target.src = this.getFallbackImage(this);
                e.target.onerror = null;
                imgWrapper.style.background = 'none';
                loadingText.style.display = 'none';
              },
              style: 'opacity: 0; transition: opacity 0.3s;',
            });

            setTimeout(() => {
              img.style.opacity = '1';
            }, 100);

            imgWrapper.appendChild(img);
            imageContainer.appendChild(imgWrapper);
          }

          const metaDiv = createElement('div', { className: 'card-meta' });

          const colorDiv = createElement('div');
          const colorIndicator = createElement('span', {
            className: `card-color ${this.getColorClass()}`,
          });
          colorDiv.appendChild(colorIndicator);
          colorDiv.append(this.colors ? this.colors.join(', ') : 'Colorless');

          const rarityDiv = createElement('div', {
            className: `card-rarity ${this.getRarityClass()}`,
            textContent: this.rarity || 'Common',
          });

          metaDiv.appendChild(colorDiv);
          metaDiv.appendChild(rarityDiv);

          const type = createElement('p', {}, this.type || 'Unknown Type');

          const manaCostDiv = createElement('div', { className: 'mana-cost' });
          manaCostDiv.innerHTML = this.manaCost
            ? `<span>Cost: </span>${this.createManaSymbols()}`
            : 'No mana cost';

          const detailsDiv = createElement('div', {
            className: 'card-details',
          });
          const details = createElement('details');
          const summary = createElement('summary', {}, 'Card Details');

          const description = createElement('p');
          description.innerHTML = this.text
            ? this.text.replace(/\n/g, '<br>')
            : 'No description available';

          details.appendChild(summary);
          details.appendChild(description);
          detailsDiv.appendChild(details);

          const button = createElement('button', {
            className: 'select',
            textContent: 'Select',
          });

          button.addEventListener('click', () => this.toggleSelection());

          const actionsDiv = createElement('div', {
            className: 'card-actions',
          });
          actionsDiv.appendChild(manaCostDiv);
          actionsDiv.appendChild(button);

          cardDiv.append(
            title,
            imageContainer,
            metaDiv,
            type,
            detailsDiv,
            actionsDiv,
          );

          this.element = cardDiv;
          return cardDiv;
        }
      }

      // CardList Class
      class CardList {
        constructor(container, counter) {
          this.container = container;
          this.counter = counter;
          this.cards = [];
        }

        async loadCards(maxCards = 12) {
          try {
            const response = await fetch(
              `https://api.magicthegathering.io/v1/cards?pageSize=${maxCards * 2}`,
              {
                mode: 'cors',
              },
            );
            const data = await response.json();

            this.cards = data.cards
              .filter((card) => card.imageUrl || card.multiverseid || card.name)
              .slice(0, maxCards)
              .map((cardData) => new Card(cardData, this.counter));

            this.render();
          } catch (error) {
            console.error('Fetch error:', error);
            this.container.innerHTML =
              '<p>Error loading cards. Please try again later.</p>';
          }
        }

        render() {
          this.container.innerHTML = '';
          this.cards.forEach((card) => {
            this.container.appendChild(card.render());
            if (card.isSelected) {
              card.updateUI();
            }
          });
        }

        selectAll() {
          this.cards.forEach((card) => {
            if (!card.isSelected) {
              card.toggleSelection();
            }
          });
        }

        deselectAll() {
          this.cards.forEach((card) => {
            if (card.isSelected) {
              card.toggleSelection();
            }
          });
        }
      }

      // Counter Class
      class Counter {
        constructor(element) {
          this.element = element;
          this.count = 0;
        }

        increment() {
          this.count++;
          this.update();
        }

        decrement() {
          if (this.count > 0) {
            this.count--;
            this.update();
          }
        }

        reset() {
          this.count = 0;
          this.update();
        }

        update() {
          this.element.textContent = `Selected: ${this.count}`;
          localStorage.setItem('selectedCount', this.count);
        }
      }

      // Navbar Component
      class Navbar {
        constructor() {
          this.menuToggle = document.getElementById('menuToggle');
          this.mobileMenu = document.getElementById('mobileMenu');
          this.themeToggle = document.getElementById('themeToggle');
          this.navThemeToggle = document.getElementById('navThemeToggle');
          this.isLocalStorageAvailable = this.checkLocalStorage();

          this.init();
        }

        checkLocalStorage() {
          try {
            const testKey = 'test';
            localStorage.setItem(testKey, testKey);
            localStorage.removeItem(testKey);
            return true;
          } catch (e) {
            console.warn('LocalStorage is not available');
            return false;
          }
        }

        init() {
          this.menuToggle.addEventListener('click', () => {
            const isExpanded =
              this.menuToggle.getAttribute('aria-expanded') === 'true';
            this.mobileMenu.classList.toggle('active');
            this.menuToggle.setAttribute('aria-expanded', String(!isExpanded));
          });

          const toggleTheme = () => {
            document.body.classList.toggle('light');
            if (this.isLocalStorageAvailable) {
              const theme = document.body.classList.contains('light')
                ? 'light'
                : 'dark';
              localStorage.setItem('theme', theme);
            }
          };

          this.themeToggle?.addEventListener('click', toggleTheme);
          this.navThemeToggle?.addEventListener('click', toggleTheme);
        }
      }

      // Main App Initialization
      document.addEventListener('DOMContentLoaded', () => {
        // Initialize components
        new Navbar();

        // Restore theme
        if (localStorage.getItem('theme') === 'light') {
          document.body.classList.add('light');
        }

        // Initialize counter
        const counterElement = document.getElementById('counter');
        const counter = new Counter(counterElement);
        if (localStorage.getItem('selectedCount')) {
          counter.count = parseInt(localStorage.getItem('selectedCount'));
          counter.update();
        }

        // Initialize card list
        const cardGrid = document.getElementById('cardGrid');
        const cardList = new CardList(cardGrid, counter);
        cardList.loadCards();

        // Set up button events
        document.getElementById('selectAll').addEventListener('click', () => {
          cardList.selectAll();
        });

        document.getElementById('deselectAll').addEventListener('click', () => {
          cardList.deselectAll();
          counter.reset();
        });
      });
    </script>
  </body>
</html>
